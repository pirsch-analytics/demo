<!DOCTYPE html>
<html>
    <head>
        <title>Pirsch Web Demo</title>
        <link rel="stylesheet" type="text/css" href="style.css" />

        <!-- Adjust the data-code attribute with your identification code and remove the data-hit-endpoint, data-event-endpoint, and data-dev attribute. -->
        <script defer src="https://localhost.com:9999/pirsch-extended.js"
            id="pirschextendedjs"
            data-code="sn5PO84zf3jV4mpPf7HRYJt9lPrFtKZC"
            data-hit-endpoint="https://localhost.com:9999/hit"
            data-event-endpoint="https://localhost.com:9999/event"
            data-dev></script>

        <!-- Add the YouTube iframe API script. -->
        <script src="https://www.youtube.com/iframe_api"></script>

        <!-- Add the Vimeo player.js script -->
        <script src="https://player.vimeo.com/api/player.js"></script>
    </head>
    <body>
        <h1>Video Tracking</h1>
        <p>
            <a href="/" class="menu">Home</a>
            <a href="page.html" class="menu">Second Page</a>
            <a href="/video.html" class="menu menu-active">Video Tracking</a>
        </p>
        <p>
            Track whether a YouTube or Vimeo video was started, and completed, and how long it played. If you have multiple videos on a site, change the event name for each of them or add the title in the metadata.
        </p>

        <!-- YouTube example. The div will be replaced with the player. -->
        <h2>YouTube</h2>
        <div id="youtube"></div>
        <script>
            // Initialize the player and set up event handlers for state changes.
            // The progress will be tracked as a number between 0 and 100%.
            // The started and completed states are tracked as 0 or 1.
            let player;
            let progress = 0;
            let started = 0;
            let completed = 0;

            // Wait until the YouTube iframe API is ready. This function must have this name!
            function onYouTubeIframeAPIReady() {
                player = new YT.Player("youtube", {
                    height: "360",
                    width: "640",
                    videoId: "dQw4w9WgXcQ",
                    events: {
                        "onStateChange": event => {
                            if (event.data === YT.PlayerState.PLAYING) {
                                started = 1;

                                // debugging
                                console.log("YouTube video playback started.");
                            } else if (event.data === YT.PlayerState.PAUSED) {
                                const p = Math.round(player.getCurrentTime() / player.getDuration() * 100);

                                if (p > progress) {
                                    progress = p;
                                }
                                
                                // debugging
                                console.log("YouTube video progress: ", progress);
                            } else if (event.data === YT.PlayerState.ENDED) {
                                progress = 100;
                                completed = 1;

                                // debugging
                                console.log("YouTube video playback ended.");
                            }
                        }
                    }
                });
            }

            // Send the progress when the page is navigated away from or the tab/window is closed.
            window.addEventListener("beforeunload", () => {
                if (started) {
                    pirsch("YouTube Playback", {
                        meta: {
                            progress,
                            started,
                            completed
                        }
                    });
                }
            });
        </script>

        <!-- Vimeo example. The div will be replaced with the player. -->
        <h2>Vimeo</h2>
        <div id="vimeo"></div>
        <script>
            // Initialize the player and set up an event handler for state changes.
            // The progress will be tracked as a number between 0 and 100%.
            // The started and completed state are tracked as 0 or 1.
            let vimeoPlayer;
            let vimeoProgress = 0;
            let vimeoStarted = 0;
            let vimeoCompleted = 0;

            document.addEventListener("DOMContentLoaded", () => {
                var iframe = document.querySelector("#vimeo");
                vimeoPlayer = new Vimeo.Player(iframe, {
                    id: 76979871, // video ID
                    width: 640
                });

                // Event listener for the play progress.
                vimeoPlayer.on("timeupdate", data => {
                    const p = Math.round(data.percent * 100);

                    if (p > vimeoProgress) {
                        vimeoProgress = p;

                        if (p >= 100) {
                            vimeoProgress = 100;
                            vimeoCompleted = 1;

                            // debugging
                            console.log("Vimeo video playback ended.");
                        }
                    }

                    // debugging
                    console.log("Vimeo video progress: ", vimeoProgress);
                });

                // Event listener triggered when the video is started.
                vimeoPlayer.on("play", () => {
                    vimeoStarted = 1;

                    // debugging
                    console.log("Vimeo video playback started.");
                });
            });

            // Send the progress when the page is navigated away from or the tab/window is closed.
            window.addEventListener("beforeunload", () => {
                if (vimeoStarted) {
                    pirsch("Vimeo Playback", {
                        meta: {
                            progress: vimeoProgress,
                            started: vimeoStarted,
                            completed: vimeoCompleted
                        }
                    });
                }
            });
        </script>
    </body>
</html>
